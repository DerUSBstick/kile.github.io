<html lang="en">
<!--Credit: Elias Cuin-->

<head>
    <meta charset="utf-8" />
    <title>Killua Dashboard</title>

    <script type='application/javascript' src="/scripts/csb.js"></script>
    <link title="Default" type='text/css' rel="stylesheet" href="/styles/dmp.css">

    <script src="./scripts/discord-login.js"></script>

    <div class="Header">
        <img href="https://killua.dev/" src="https://i.ibb.co/pdL4Zmw/killua.webp">
        <a class="nav-link" href="https://discord.com/oauth2/authorize?client_id=756206646396452975&scope=bot&permissions=1342531648">Add To Server</a>
        <a class="nav-link" href="https://discord.gg/FdErZCd">Discord Server</a>
        <a class="nav-link" href="https://www.patreon.com/KileAlkuri">Patreon</a>
        <a class="nav-link" href="../commands">Commands</a>
        <a class="nav-link" href="">Dashboard</a>
        <a class="nav-link" href='https://discord.com/api/oauth2/authorize?client_id=760215687141785601&redirect_uri=http%3A%2F%2Flocalhost%3A8081&response_type=code&scope=identify%20email%20guilds%20connections'>Login With Discord</a>
    </div>
</head>

<body>
    <p id='display_result'></p>
    <div class="TitleText">
        <h1 class="text1">Your Guilds</h1>
        <p class="text2">You can only modify the bot settings for servers were you are admins.</p>
    </div>
    <div class="Buttons">
        <div class="guilds">
            <!--The guild buttons-->
        </div>
    </div>
</body>

<footer>
    <p>
        <a class="FooterText" href="TO IMPRINT">Imprint</a>
    </p>
</footer>
<script>
    window.onload = () => {
        console.log('hi');
        const code = location.href.substring(location.href.indexOf("code") + 5, location.href.length)
        if (location.href.indexOf("code") > -1) {
            const req = new XMLHttpRequest()
            const req2 = new XMLHttpRequest()
            const req3 = new XMLHttpRequest()
            req.open("POST", "http://localhost:8081")
            req.send(code)
            req.onload = () => {
                console.log(req.response);
                if (req.status.toString().startsWith('5')) {
                    document.getElementById('display_result').innerText = `There was an error with that. Please try logging in again. Error Code: ${req.status}`;
                } else if (req.status == 200) {
                    req2.open("POST", "http://localhost:8081/kg")
                    req2.send(code)
                    req2.onload = () => {
                        var tr2 = JSON.parse(req2.response);
                        console.log(tr2);
                        req3.open("POST", "http://localhost:8081/dg");
                        req3.send(code);
                        req3.onload = () => {
                            var tutgr = req3.response;
                            var tutg = [];
                            const data = JSON.parse(req3.response);
                            Object.keys(data).forEach(function(key) {
                                //get the value of name
                                var val = data[key]["id"];
                                //push the name string in the array
                                tutg.push(val);
                            });
                            cg = getCommon(tutg, tr2);
                            console.log(cg);

                            data.sort((a, b) => a.perms && b.perms ? 0 : (a.perms && !b.perms ? -1 : 1));
                            for (const s of data)
                                createServerButton(s.id, s.name, `https://cdn.discordapp.com/icons/${s.id}/${s.icon}.webp?size=128`, s.perms);

                        }
                    }

                }

            }
        } else {
            document.getElementById('display_result').innerText = `Something went wrong. Please try logging in again. Error Code: ${req.status}`;
        }
    }
</script>

</html>
